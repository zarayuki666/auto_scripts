name: ğŸ”„ XServer Auto Renew

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # å®šæ—¶è§¦å‘
  schedule:
    # UTC 01:30 (åŒ—äº¬æ—¶é—´ 09:30)
    - cron: "30 1 * * *"
    # UTC 15:55 (åŒ—äº¬æ—¶é—´æ¬¡æ—¥ 00:55)
    - cron: "55 15 * * *"

# æƒé™é…ç½®ï¼šå…è®¸æäº¤å’Œæ¨é€æ›´æ”¹
permissions:
  contents: write

# å¹¶å‘æ§åˆ¶ï¼šé˜²æ­¢å¤šä¸ªå·¥ä½œæµå®ä¾‹åŒæ—¶è¿è¡Œ
concurrency:
  group: ${{ github.repository }}-xserver-runner
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      PROJECT_DIR: xserver
      SCRIPT_NAME: renew.py
      SCRIPT_DESC: XServer ç»­æœŸè„šæœ¬
    
    steps:
      # æ­¥éª¤ 1: æ£€å‡ºå…¬å¼€ä»“åº“
      - name: ğŸ“¥ æ£€å‡ºå…¬å¼€ä»“åº“
        uses: actions/checkout@v4
      
      # æ­¥éª¤ 1.5: åˆ›å»ºè¾“å‡ºç›®å½•
      - name: ğŸ“ åˆ›å»ºè¾“å‡ºç›®å½•
        run: mkdir -p ${{ github.repository_owner }}-${{ github.event.repository.name }}-${{ env.PROJECT_DIR }}
        working-directory: .
      
      # æ­¥éª¤ 2: æ£€å‡ºç§æœ‰ä»“åº“
      - name: ğŸ” æ£€å‡ºç§æœ‰ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: jyucoeng/auto_xserver_private
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          ref: main
          path: ${{ github.repository_owner }}-${{ github.event.repository.name }}-${{ env.PROJECT_DIR }}
          fetch-depth: 1

      # æ­¥éª¤ 3: è®¾ç½® Python ç¯å¢ƒ
      - name: ğŸ è®¾ç½® Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"
          cache-dependency-path: "**/requirements.txt"

      # æ­¥éª¤ 4: å®‰è£…ç³»ç»Ÿä¾èµ–
      - name: ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb fonts-noto-cjk fonts-noto-cjk-extra

      # æ­¥éª¤ 5: å®‰è£… Python ä¾èµ–
      - name: ğŸ“š å®‰è£… Python ä¾èµ–
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "âš ï¸ æœªæ‰¾åˆ° requirements.txtï¼Œè·³è¿‡ä¾èµ–å®‰è£…"
          fi
        working-directory: ${{ github.repository_owner }}-${{ github.event.repository.name }}-${{ env.PROJECT_DIR }}

      # æ­¥éª¤ 5.5: å®‰è£… Playwright æµè§ˆå™¨
      - name: ğŸŒ å®‰è£… Playwright æµè§ˆå™¨
        run: |
          python -m playwright install chromium
        working-directory: ${{ github.repository_owner }}-${{ github.event.repository.name }}-${{ env.PROJECT_DIR }}

      # æ­¥éª¤ 6: æ·»åŠ éšæœºå»¶è¿Ÿ
      - name: â³ æ·»åŠ éšæœºå»¶è¿Ÿ
        run: |
          delay=$((RANDOM % 120))
          echo "éšæœºå»¶è¿Ÿ: ${delay}ç§’"
          sleep $delay

      # æ­¥éª¤ 7: æ‰§è¡Œè„šæœ¬
      - name: ğŸš€ æ‰§è¡Œ ${{ env.SCRIPT_DESC }}
        env:
          XSERVER_EMAIL: ${{ secrets.XSERVER_GAME_EMAIL }}
          XSERVER_PASSWORD: ${{ secrets.XSERVER_GAME_PASSWORD }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.XSERVER_GAME_TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.XSERVER_GAME_TELEGRAM_CHAT_ID }}
          USE_PROXY: ${{ secrets.XSERVER_GAME_USE_PROXY }}

          #ä»¥ä¸‹2ä¸ªä¸è¦åŠ¨ï¼Œä¸ä¼šè¯·ä¸è¦ç¢°
          OUTPUT_DIR: ./
          SCREENSHOT_DIR: ./screenshots
        run: xvfb-run -a python ${{ env.SCRIPT_NAME }}
        working-directory: ${{ github.repository_owner }}-${{ github.event.repository.name }}-${{ env.PROJECT_DIR }}

      # æ­¥éª¤ 7.5: è°ƒè¯• - æ£€æŸ¥æ–‡ä»¶ä½ç½®
      - name: ğŸ” è°ƒè¯• - æ£€æŸ¥æ–‡ä»¶ä½ç½®
        if: always()
        run: |
          echo "ğŸ“‚ å½“å‰ç›®å½•: $(pwd)"
          echo "ğŸ“‚ åˆ—å‡ºæ ¹ç›®å½•:"
          ls -la
          echo "ğŸ“‚ æ£€æŸ¥ç§åº“ç›®å½•å†…å®¹:"
          OUTPUT_DIR="${{ github.repository_owner }}-${{ github.event.repository.name }}-${{ env.PROJECT_DIR }}"
          ls -la "$OUTPUT_DIR" 2>/dev/null || echo "ç›®å½•ä¸å­˜åœ¨"
          echo "ğŸ“‚ æŸ¥æ‰¾æ‰€æœ‰ report-notify.md æ–‡ä»¶:"
          find . -name "report-notify.md" 2>/dev/null || echo "æœªæ‰¾åˆ°"
          echo "ğŸ“‚ æŸ¥æ‰¾æ‰€æœ‰ time.txt æ–‡ä»¶:"
          find . -name "time.txt" 2>/dev/null || echo "æœªæ‰¾åˆ°"

      # æ­¥éª¤ 8: æ”¶é›†æŠ¥å‘Šæ–‡ä»¶
      - name: ğŸ“‹ æ”¶é›†æŠ¥å‘Šæ–‡ä»¶
        if: always()
        run: |
          OUTPUT_DIR="${{ github.repository_owner }}-${{ github.event.repository.name }}-${{ env.PROJECT_DIR }}"
          mkdir -p "$OUTPUT_DIR"
          if [ -f "$OUTPUT_DIR/report-notify.md" ]; then
            echo "âœ… æŠ¥å‘Šæ–‡ä»¶å·²æ‰¾åˆ°"
          else
            echo "âš ï¸ æœªæ‰¾åˆ° report-notify.mdï¼Œåˆ›å»ºç©ºæ–‡ä»¶"
            echo "# XServer ç»­æœŸæŠ¥å‘Š" > "$OUTPUT_DIR/report-notify.md"
            echo "" >> "$OUTPUT_DIR/report-notify.md"
            echo "è„šæœ¬æœªç”ŸæˆæŠ¥å‘Šæ–‡ä»¶" >> "$OUTPUT_DIR/report-notify.md"
          fi

      # æ­¥éª¤ 9: æ·»åŠ æŠ¥å‘Šå¤´éƒ¨
      - name: ğŸ“ æ·»åŠ æŠ¥å‘Šå¤´éƒ¨
        if: always()
        run: |
          OUTPUT_DIR="${{ github.repository_owner }}-${{ github.event.repository.name }}-${{ env.PROJECT_DIR }}"
          if [ -f "$OUTPUT_DIR/report-notify.md" ]; then
            TIMESTAMP=$(date -u +'%Y-%m-%d %H:%M:%S')
            {
              printf "Runner repo: %s | Run ID: %s | UTC: %s\n\n" \
                "$GITHUB_REPOSITORY" "$GITHUB_RUN_ID" "$TIMESTAMP"
              cat "$OUTPUT_DIR/report-notify.md"
            } > "$OUTPUT_DIR/temp" && mv "$OUTPUT_DIR/temp" "$OUTPUT_DIR/report-notify.md"
            echo "âœ… æŠ¥å‘Šå¤´éƒ¨å·²æ·»åŠ "
          else
            echo "âš ï¸ æŠ¥å‘Šæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡æ·»åŠ å¤´éƒ¨"
          fi

      # æ­¥éª¤ 10: æ›´æ–°æ—¶é—´æ–‡ä»¶
      - name: â±ï¸ æ›´æ–°æ—¶é—´æ–‡ä»¶
        if: always()
        run: |
          OUTPUT_DIR="${{ github.repository_owner }}-${{ github.event.repository.name }}-${{ env.PROJECT_DIR }}"
          mkdir -p "$OUTPUT_DIR"
          TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S')
          echo "$TIMESTAMP" > "$OUTPUT_DIR/time.txt"
          echo "âœ… æ—¶é—´æ–‡ä»¶å·²æ›´æ–°: $OUTPUT_DIR/time.txt"

      # æ­¥éª¤ 11: æäº¤å’Œæ¨é€æ›´æ”¹
      - name: ğŸ’¾ æäº¤å’Œæ¨é€æ›´æ”¹
        if: always()
        run: |
          set -e
          OUTPUT_DIR="${{ github.repository_owner }}-${{ github.event.repository.name }}-${{ env.PROJECT_DIR }}"
          echo "ğŸ“‚ OUTPUT_DIR: $OUTPUT_DIR"
          echo "ğŸ“‚ å½“å‰ç›®å½•: $(pwd)"
          echo "ğŸ“‚ æ£€æŸ¥ OUTPUT_DIR å†…å®¹:"
          ls -la "$OUTPUT_DIR" 2>/dev/null || echo "âš ï¸ OUTPUT_DIR ä¸å­˜åœ¨"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # åˆ›å»º xserver ç›®å½•
          mkdir -p xserver
          echo "âœ… xserver ç›®å½•å·²åˆ›å»º"
          
          # ä»ç§åº“ç›®å½•å¤åˆ¶æ–‡ä»¶åˆ°å…¬å¼€åº“çš„ xserver ç›®å½•
          if [ -f "$OUTPUT_DIR/report-notify.md" ]; then
            cp "$OUTPUT_DIR/report-notify.md" "xserver/report-notify.md"
            echo "âœ… æŠ¥å‘Šæ–‡ä»¶å·²å¤åˆ¶åˆ° xserver ç›®å½•"
          else
            echo "âš ï¸ æŠ¥å‘Šæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºç©ºæ–‡ä»¶"
            echo "# XServer ç»­æœŸæŠ¥å‘Š" > "xserver/report-notify.md"
            echo "è„šæœ¬æœªç”ŸæˆæŠ¥å‘Šæ–‡ä»¶" >> "xserver/report-notify.md"
          fi
          
          if [ -f "$OUTPUT_DIR/time.txt" ]; then
            cp "$OUTPUT_DIR/time.txt" "xserver/time.txt"
            echo "âœ… æ—¶é—´æ–‡ä»¶å·²å¤åˆ¶åˆ° xserver ç›®å½•"
          else
            echo "âš ï¸ æ—¶é—´æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°æ–‡ä»¶"
            date +'%Y-%m-%d %H:%M:%S' > "xserver/time.txt"
          fi
          
          echo "ğŸ“‚ xserver ç›®å½•å†…å®¹:"
          ls -la xserver/
          
          # æ·»åŠ æ–‡ä»¶åˆ° git
          git add "xserver/report-notify.md" "xserver/time.txt" 2>/dev/null || true
          
          if git diff --cached --quiet; then
            echo "æ— å˜åŒ–ï¼Œæ— éœ€æäº¤"
          else
            TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S')
            git commit -m "â±ï¸ æ›´æ–° xserver æ–‡ä»¶: $TIMESTAMP"
            git fetch origin main
            git push -f origin HEAD:main
            echo "âœ… æ›´æ”¹å·²æ¨é€"
          fi

      # æ­¥éª¤ 12: ä¸Šä¼ æˆªå›¾åˆ° artifactsï¼Œ7å¤©å†…å¯ä¸‹è½½å‹ç¼©åŒ…ï¼Œä½ å¯ä»¥è‡ªå·±æ”¹è¿™ä¸ªæ•°å­—7
      - name: ğŸ“¸ ä¸Šä¼ æˆªå›¾åˆ° artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots
          path: ${{ github.repository_owner }}-${{ github.event.repository.name }}-${{ env.PROJECT_DIR }}/screenshots
          retention-days: 7
          if-no-files-found: warn

      # æ­¥éª¤ 13: æ¸…ç†åŸå§‹æˆªå›¾æ–‡ä»¶
      - name: ğŸ§¹ æ¸…ç†åŸå§‹æˆªå›¾æ–‡ä»¶
        if: always()
        run: |
          OUTPUT_DIR="${{ github.repository_owner }}-${{ github.event.repository.name }}-${{ env.PROJECT_DIR }}"
          if [ -d "$OUTPUT_DIR/screenshots" ]; then
            echo "ğŸ§¹ æ¸…ç†æˆªå›¾æ–‡ä»¶..."
            rm -f "$OUTPUT_DIR/screenshots"/*.png
            echo "âœ… æˆªå›¾æ–‡ä»¶å·²æ¸…ç†"
          else
            echo "âš ï¸ æˆªå›¾ç›®å½•ä¸å­˜åœ¨ï¼Œæ— éœ€æ¸…ç†"
          fi
